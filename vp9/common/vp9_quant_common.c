/*
 *  Copyright (c) 2010 The WebM project authors. All Rights Reserved.
 *
 *  Use of this source code is governed by a BSD-style license
 *  that can be found in the LICENSE file in the root of the source
 *  tree. An additional intellectual property rights grant can be found
 *  in the file PATENTS.  All contributing project authors may
 *  be found in the AUTHORS file in the root of the source tree.
 */

#include "vp9/common/vp9_common.h"
#include "vp9/common/vp9_quant_common.h"
#include "vp9/common/vp9_seg_common.h"

#if 1
static const int16_t dc_qlookup[QINDEX_RANGE] = {
  4,       8,    8,    9,   10,   11,   12,   12,
  13,     14,   15,   16,   17,   18,   19,   19,
  20,     21,   22,   23,   24,   25,   26,   26,
  27,     28,   29,   30,   31,   32,   32,   33,
  34,     35,   36,   37,   38,   38,   39,   40,
  41,     42,   43,   43,   44,   45,   46,   47,
  48,     48,   49,   50,   51,   52,   53,   53,
  54,     55,   56,   57,   57,   58,   59,   60,
  61,     62,   62,   63,   64,   65,   66,   66,
  67,     68,   69,   70,   70,   71,   72,   73,
  74,     74,   75,   76,   77,   78,   78,   79,
  80,     81,   81,   82,   83,   84,   85,   85,
  87,     88,   90,   92,   93,   95,   96,   98,
  99,    101,  102,  104,  105,  107,  108,  110,
  111,   113,  114,  116,  117,  118,  120,  121,
  123,   125,  127,  129,  131,  134,  136,  138,
  140,   142,  144,  146,  148,  150,  152,  154,
  156,   158,  161,  164,  166,  169,  172,  174,
  177,   180,  182,  185,  187,  190,  192,  195,
  199,   202,  205,  208,  211,  214,  217,  220,
  223,   226,  230,  233,  237,  240,  243,  247,
  250,   253,  257,  261,  265,  269,  272,  276,
  280,   284,  288,  292,  296,  300,  304,  309,
  313,   317,  322,  326,  330,  335,  340,  344,
  349,   354,  359,  364,  369,  374,  379,  384,
  389,   395,  400,  406,  411,  417,  423,  429,
  435,   441,  447,  454,  461,  467,  475,  482,
  489,   497,  505,  513,  522,  530,  539,  549,
  559,   569,  579,  590,  602,  614,  626,  640,
  654,   668,  684,  700,  717,  736,  755,  775,
  796,   819,  843,  869,  896,  925,  955,  988,
  1022, 1058, 1098, 1139, 1184, 1232, 1282, 1336,
};

#if CONFIG_VP9_HIGH && CONFIG_HIGH_TRANSFORMS && CONFIG_HIGH_QUANT
static const int16_t dc_qlookup_10[QINDEX_RANGE] = {
  4,     8,     8,     9,     10,    11,    12,    13,
  13,    14,    15,    16,    17,    18,    19,    20,
  21,    22,    22,    23,    24,    25,    26,    27,
  28,    29,    30,    30,    31,    32,    33,    34,
  35,    36,    37,    38,    38,    39,    40,    41,
  42,    43,    44,    45,    45,    46,    47,    48,
  49,    50,    51,    52,    53,    53,    54,    55,
  56,    57,    58,    59,    60,    60,    61,    62,
  63,    64,    65,    66,    67,    67,    69,    71,
  73,    74,    76,    78,    80,    81,    83,    85,
  87,    88,    90,    92,    94,    95,    97,    99,
  101,   103,   106,   108,   111,   113,   116,   119,
  121,   124,   126,   129,   131,   134,   137,   141,
  144,   148,   151,   154,   158,   161,   164,   168,
  172,   176,   180,   185,   189,   193,   197,   202,
  207,   212,   217,   222,   227,   232,   237,   243,
  249,   254,   260,   266,   273,   279,   286,   292,
  299,   306,   313,   320,   328,   336,   344,   352,
  360,   368,   377,   385,   394,   403,   413,   422,
  432,   442,   452,   462,   473,   483,   494,   506,
  517,   529,   541,   553,   565,   578,   591,   604,
  618,   631,   645,   659,   674,   688,   703,   719,
  734,   750,   767,   783,   800,   817,   834,   851,
  869,   888,   906,   925,   944,   963,   983,   1003,
  1023,  1044,  1065,  1086,  1108,  1130,  1152,  1174,
  1197,  1220,  1244,  1268,  1292,  1317,  1342,  1367,
  1393,  1419,  1446,  1474,  1501,  1530,  1558,  1588,
  1618,  1649,  1681,  1713,  1746,  1781,  1816,  1853,
  1890,  1930,  1971,  2013,  2058,  2104,  2153,  2204,
  2257,  2314,  2374,  2438,  2505,  2577,  2654,  2737,
  2825,  2920,  3022,  3132,  3251,  3380,  3518,  3669,
  3831,  4009,  4203,  4412,  4641,  4890,  5162,  5459,
};

static const int16_t dc_qlookup_12[QINDEX_RANGE] = {
  4,     8,     8,     9,     10,    11,    12,    13,
  13,    14,    15,    16,    17,    18,    19,    20,
  21,    22,    22,    23,    24,    25,    26,    27,
  28,    29,    30,    31,    31,    32,    33,    34,
  35,    36,    37,    38,    39,    40,    40,    41,
  42,    43,    44,    45,    46,    47,    48,    48,
  49,    50,    51,    52,    53,    54,    55,    56,
  57,    59,    61,    63,    65,    66,    68,    70,
  72,    74,    75,    77,    79,    81,    82,    85,
  88,    90,    93,    96,    99,    101,   104,   107,
  109,   112,   115,   119,   123,   126,   130,   133,
  137,   140,   145,   149,   154,   158,   162,   167,
  172,   178,   183,   188,   193,   200,   206,   212,
  218,   224,   231,   238,   245,   253,   261,   269,
  277,   286,   294,   303,   313,   322,   332,   342,
  353,   364,   375,   387,   399,   411,   424,   437,
  450,   464,   479,   493,   509,   524,   540,   557,
  574,   592,   611,   629,   648,   669,   690,   711,
  732,   755,   778,   802,   827,   852,   879,   906,
  933,   962,   991,   1021,  1053,  1085,  1118,  1151,
  1186,  1222,  1259,  1296,  1335,  1375,  1416,  1459,
  1502,  1546,  1592,  1639,  1687,  1736,  1787,  1840,
  1893,  1948,  2005,  2063,  2122,  2183,  2245,  2309,
  2375,  2442,  2510,  2580,  2652,  2726,  2801,  2878,
  2956,  3036,  3117,  3201,  3287,  3374,  3463,  3554,
  3646,  3740,  3837,  3935,  4035,  4137,  4241,  4347,
  4455,  4564,  4676,  4790,  4905,  5023,  5144,  5266,
  5391,  5519,  5649,  5782,  5918,  6057,  6199,  6345,
  6496,  6651,  6810,  6975,  7146,  7324,  7509,  7702,
  7905,  8119,  8344,  8582,  8835,  9105,  9393,  9704,
  10039, 10401, 10794, 11222, 11689, 12200, 12761, 13379,
  14060, 14812, 15645, 16567, 17591, 18728, 19993, 21402,
};
#endif

static const int16_t ac_qlookup[QINDEX_RANGE] = {
  4,       8,    9,   10,   11,   12,   13,   14,
  15,     16,   17,   18,   19,   20,   21,   22,
  23,     24,   25,   26,   27,   28,   29,   30,
  31,     32,   33,   34,   35,   36,   37,   38,
  39,     40,   41,   42,   43,   44,   45,   46,
  47,     48,   49,   50,   51,   52,   53,   54,
  55,     56,   57,   58,   59,   60,   61,   62,
  63,     64,   65,   66,   67,   68,   69,   70,
  71,     72,   73,   74,   75,   76,   77,   78,
  79,     80,   81,   82,   83,   84,   85,   86,
  87,     88,   89,   90,   91,   92,   93,   94,
  95,     96,   97,   98,   99,  100,  101,  102,
  104,   106,  108,  110,  112,  114,  116,  118,
  120,   122,  124,  126,  128,  130,  132,  134,
  136,   138,  140,  142,  144,  146,  148,  150,
  152,   155,  158,  161,  164,  167,  170,  173,
  176,   179,  182,  185,  188,  191,  194,  197,
  200,   203,  207,  211,  215,  219,  223,  227,
  231,   235,  239,  243,  247,  251,  255,  260,
  265,   270,  275,  280,  285,  290,  295,  300,
  305,   311,  317,  323,  329,  335,  341,  347,
  353,   359,  366,  373,  380,  387,  394,  401,
  408,   416,  424,  432,  440,  448,  456,  465,
  474,   483,  492,  501,  510,  520,  530,  540,
  550,   560,  571,  582,  593,  604,  615,  627,
  639,   651,  663,  676,  689,  702,  715,  729,
  743,   757,  771,  786,  801,  816,  832,  848,
  864,   881,  898,  915,  933,  951,  969,  988,
  1007, 1026, 1046, 1066, 1087, 1108, 1129, 1151,
  1173, 1196, 1219, 1243, 1267, 1292, 1317, 1343,
  1369, 1396, 1423, 1451, 1479, 1508, 1537, 1567,
  1597, 1628, 1660, 1692, 1725, 1759, 1793, 1828,
};

#if CONFIG_VP9_HIGH && CONFIG_HIGH_TRANSFORMS && CONFIG_HIGH_QUANT
static const int16_t ac_qlookup_10[QINDEX_RANGE] = {
  4,     8,     9,     10,    11,    12,    13,    14,
  15,    16,    17,    18,    19,    20,    21,    22,
  23,    24,    25,    26,    27,    28,    29,    30,
  31,    32,    33,    34,    35,    36,    37,    38,
  39,    40,    41,    42,    43,    44,    45,    46,
  47,    48,    49,    50,    51,    52,    53,    54,
  55,    56,    57,    58,    59,    60,    61,    62,
  63,    64,    65,    66,    67,    68,    69,    70,
  71,    72,    73,    74,    75,    76,    78,    80,
  82,    84,    86,    88,    90,    92,    94,    96,
  98,    100,   102,   104,   106,   108,   110,   112,
  114,   117,   120,   123,   126,   129,   132,   135,
  138,   141,   144,   147,   150,   153,   157,   161,
  165,   169,   173,   177,   181,   185,   189,   193,
  198,   203,   208,   213,   218,   223,   228,   234,
  240,   246,   252,   258,   264,   270,   277,   284,
  291,   298,   305,   313,   321,   329,   337,   345,
  354,   363,   372,   381,   391,   401,   411,   421,
  432,   443,   454,   465,   477,   489,   501,   514,
  527,   540,   554,   568,   582,   597,   612,   628,
  644,   660,   677,   694,   712,   730,   749,   768,
  788,   808,   829,   850,   872,   894,   917,   941,
  965,   990,   1016,  1042,  1069,  1097,  1125,  1154,
  1184,  1215,  1246,  1278,  1311,  1345,  1380,  1416,
  1453,  1491,  1530,  1570,  1611,  1653,  1696,  1740,
  1785,  1831,  1879,  1928,  1978,  2030,  2083,  2137,
  2193,  2250,  2309,  2369,  2431,  2494,  2559,  2626,
  2695,  2765,  2837,  2911,  2987,  3065,  3145,  3227,
  3311,  3398,  3487,  3578,  3672,  3768,  3867,  3968,
  4072,  4179,  4288,  4400,  4515,  4633,  4754,  4879,
  5007,  5138,  5273,  5411,  5553,  5699,  5848,  6001,
  6158,  6320,  6486,  6656,  6831,  7010,  7194,  7383,
};

static const int16_t ac_qlookup_12[QINDEX_RANGE] = {
  4,     8,     9,     10,    11,    12,    13,    14,
  15,    16,    17,    18,    19,    20,    21,    22,
  23,    24,    25,    26,    27,    28,    29,    30,
  31,    32,    33,    34,    35,    36,    37,    38,
  39,    40,    41,    42,    43,    44,    45,    46,
  47,    48,    49,    50,    51,    52,    53,    54,
  55,    56,    57,    58,    59,    60,    61,    62,
  64,    66,    68,    70,    72,    74,    76,    78,
  80,    82,    84,    86,    88,    90,    92,    95,
  98,    101,   104,   107,   110,   113,   116,   119,
  122,   125,   129,   133,   137,   141,   145,   149,
  153,   157,   162,   167,   172,   177,   182,   187,
  193,   199,   205,   211,   217,   224,   231,   238,
  245,   252,   260,   268,   276,   285,   294,   303,
  312,   322,   332,   342,   353,   364,   375,   387,
  399,   412,   425,   438,   452,   466,   481,   496,
  512,   528,   545,   562,   580,   598,   617,   637,
  657,   678,   700,   722,   745,   769,   794,   819,
  845,   872,   900,   929,   959,   990,   1022,  1055,
  1089,  1124,  1160,  1197,  1236,  1276,  1317,  1359,
  1403,  1448,  1495,  1543,  1593,  1644,  1697,  1752,
  1809,  1867,  1927,  1989,  2053,  2119,  2188,  2259,
  2332,  2408,  2486,  2567,  2650,  2736,  2825,  2917,
  3012,  3110,  3211,  3315,  3423,  3534,  3649,  3767,
  3889,  4015,  4145,  4280,  4419,  4563,  4711,  4864,
  5022,  5185,  5354,  5528,  5708,  5894,  6086,  6284,
  6488,  6699,  6917,  7142,  7374,  7614,  7862,  8118,
  8382,  8655,  8937,  9228,  9528,  9838,  10158, 10489,
  10831, 11184, 11548, 11924, 12312, 12713, 13127, 13555,
  13997, 14453, 14924, 15410, 15912, 16430, 16965, 17518,
  18089, 18678, 19287, 19915, 20564, 21234, 21926, 22640,
  23378, 24140, 24927, 25739, 26578, 27444, 28338, 29262,
};
#endif


void vp9_init_quant_tables(void) { }
#else
static int16_t dc_qlookup[QINDEX_RANGE];
static int16_t ac_qlookup[QINDEX_RANGE];

#define ACDC_MIN 8

// TODO(dkovalev) move to common and reuse
static double poly3(double a, double b, double c, double d, double x) {
  return a*x*x*x + b*x*x + c*x + d;
}

void vp9_init_quant_tables() {
  int i, val = 4;

  // A "real" q of 1.0 forces lossless mode.
  // In practice non lossless Q's between 1.0 and 2.0 (represented here by
  // integer values from 5-7 give poor rd results (lower psnr and often
  // larger size than the lossless encode. To block out those "not very useful"
  // values we increment the ac and dc q lookup values by 4 after position 0.
  ac_qlookup[0] = val;
  dc_qlookup[0] = val;
  val += 4;

  for (i = 1; i < QINDEX_RANGE; i++) {
    const int ac_val = val;

    val = (int)(val * 1.01975);
    if (val == ac_val)
      ++val;

    ac_qlookup[i] = (int16_t)ac_val;
    dc_qlookup[i] = (int16_t)MAX(ACDC_MIN, poly3(0.000000305, -0.00065, 0.9,
                                                 0.5, ac_val));
  }
}
#endif

int16_t vp9_dc_quant(int qindex, int delta, vpx_bit_depth_t bit_depth) {
#if CONFIG_VP9_HIGH && CONFIG_HIGH_TRANSFORMS && CONFIG_HIGH_QUANT
  switch (bit_depth) {
    case VPX_BITS_8:
      return dc_qlookup[clamp(qindex + delta, 0, MAXQ)];
    case VPX_BITS_10:
      return dc_qlookup_10[clamp(qindex + delta, 0, MAXQ)];
    case VPX_BITS_12:
      return dc_qlookup_12[clamp(qindex + delta, 0, MAXQ)];
    default:
      assert(0 && "bit_depth should be VPX_BITS_8, VPX_BITS_10 or VPX_BITS_12");
  }
#elif CONFIG_VP9_HIGH && CONFIG_HIGH_TRANSFORMS
  switch (bit_depth) {
    case VPX_BITS_8:
      return dc_qlookup[clamp(qindex + delta, 0, MAXQ)];
    case VPX_BITS_10:
      return dc_qlookup[clamp(qindex + delta, 0, MAXQ)] << 2;
    case VPX_BITS_12:
      return dc_qlookup[clamp(qindex + delta, 0, MAXQ)] << 4;
    default:
      assert(0 && "bit_depth should be VPX_BITS_8, VPX_BITS_10 or VPX_BITS_12");
  }
#else
  (void) bit_depth;
  return dc_qlookup[clamp(qindex + delta, 0, MAXQ)];
#endif
}

int16_t vp9_ac_quant(int qindex, int delta, vpx_bit_depth_t bit_depth) {
#if CONFIG_VP9_HIGH && CONFIG_HIGH_TRANSFORMS && CONFIG_HIGH_QUANT
  switch (bit_depth) {
    case VPX_BITS_8:
      return ac_qlookup[clamp(qindex + delta, 0, MAXQ)];
    case VPX_BITS_10:
      return ac_qlookup_10[clamp(qindex + delta, 0, MAXQ)];
    case VPX_BITS_12:
      return ac_qlookup_12[clamp(qindex + delta, 0, MAXQ)];
    default:
      assert(0 && "bit_depth should be VPX_BITS_8, VPX_BITS_10 or VPX_BITS_12");
  }
#elif CONFIG_VP9_HIGH && CONFIG_HIGH_TRANSFORMS
  switch (bit_depth) {
    case VPX_BITS_8:
      return ac_qlookup[clamp(qindex + delta, 0, MAXQ)];
    case VPX_BITS_10:
      return ac_qlookup[clamp(qindex + delta, 0, MAXQ)] << 2;
    case VPX_BITS_12:
      return ac_qlookup[clamp(qindex + delta, 0, MAXQ)] << 4;
    default:
      assert(0 && "bit_depth should be VPX_BITS_8, VPX_BITS_10 or VPX_BITS_12");
  }
#else
  (void) bit_depth;
  return ac_qlookup[clamp(qindex + delta, 0, MAXQ)];
#endif
}

int vp9_get_qindex(const struct segmentation *seg, int segment_id,
                   int base_qindex, vpx_bit_depth_t bit_depth) {
  if (vp9_segfeature_active(seg, segment_id, SEG_LVL_ALT_Q)) {
    const int data = vp9_get_segdata(seg, segment_id, SEG_LVL_ALT_Q);
    const int seg_qindex = seg->abs_delta == SEGMENT_ABSDATA ?
        data : base_qindex + data;
    return clamp(seg_qindex, 0, MAXQ);
  } else {
    return base_qindex;
  }
}
